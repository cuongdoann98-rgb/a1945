
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nạp Coins TikTok</title>
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(err => {
        console.warn('Service worker registration failed:', err);
      });
    }
  </script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: center;
      color: #111;
    }

    .phone {
      width: 100%;
      max-width: 420px;
      background: transparent;
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }

    header.ios-header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 420px;
      display: grid;
      grid-template-columns: 48px 1fr 48px;
      align-items: center;
      justify-items: center;
      background: #fff;
      padding: 12px 0;
      font-weight: 600;
      font-size: 17px;
      border-bottom: 1px solid #eee;
      height: 52px;
      z-index: 1000;
      box-sizing: border-box;
    }
    .ios-header .back-btn {
      position: static;
      width: 48px;
      height: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 12px;
      font-size: 22px;
      color: #000;
      cursor: pointer;
      background: none;
      border: none;
    }
    .ios-title {
      grid-column: 2;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* container dùng cùng padding ngang như payment-footer => phần giữa khớp với nút đỏ */
    .main-content { margin-top: 70px; }
    .container { margin: 0 auto; padding: 20px 16px 180px; box-sizing: border-box; max-width: 420px; width: 100%; display:flex; flex-direction:column; gap:20px; }

    /* đảm bảo các phần giữa chiếm đúng bề ngang nội dung */
    .balance-box, .recharge-section, .tiktok-input-wrapper, .coins-grid {
      width: 100%;
      box-sizing: border-box;
    }

    .balance-box { display:flex; align-items:center; background:#fff; border-radius:12px; padding:12px 15px; gap:12px; border: 1px solid rgba(0,0,0,0.03); }
    .tiktok-logo { width:40px; height:40px; object-fit:contain; }
    .balance-info { display:flex; flex-direction:column; gap:4px; }
    .recharge-text { font-size:18px; font-weight:700; color:#000; }
    .balance-line { display:flex; align-items:center; gap:8px; }
    .coin-icon { width:18px; height:18px; }
    #balanceAmount { font-size:13px; color:#666; border:none; background:transparent; width:auto; }

    .recharge-section { background: transparent; border-radius:12px; padding:0; }
    .recharge-section h3 { margin:0 0 8px 0; font-size:23px; font-weight:700; }

    .tiktok-input-wrapper { display:flex; align-items:center; border:1.5px solid #d0d0d0; border-radius:10px; padding:0 10px; background:#f9f9f9; }
    .tiktok-input-wrapper input { border:none; outline:none; flex:1; font-size:14px; padding:10px 0; background:transparent; width:100%; }

    /* 2 cột bằng nhau, đầy đủ chiều rộng nội dung */
    .coins-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
      align-items: start;
    }
    .coin-option {
      background: #e3e3e3;
      border: 1.5px solid #d0d0d0;
      border-radius: 10px;
      padding: 12px 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.18s;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      user-select: none;
      box-sizing: border-box;
      width: 100%;
    }
    .coin-option:focus { outline: 3px solid rgba(254,44,85,0.12); }
    .coin-option.selected { border-color: #fe2c55; background: #fff2f5; }
    .coin-option.disabled { opacity: 0.45; pointer-events: none; }
    .coin-value { font-weight:600; font-size:18px; display:flex; align-items:center; justify-content:center; gap:6px; }
    .coin-value img { width:18px; height:18px; }
    .coin-price { font-size:13px; color:#777; }

    .payment-footer { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 420px; background: #fff; border-top: 1px solid #eee; box-shadow: 0 -3px 10px rgba(0,0,0,0.06); padding:12px 16px; box-sizing:border-box; z-index:1000; }
    .payment-logos { display:flex; flex-wrap:wrap; gap:6px; align-self:flex-start; }
    .pay-icon { height:14px; width:auto; object-fit:contain; }
    .total-line { display:flex; justify-content:space-between; width:100%; font-size:15px; color:#333; margin:8px 0; }
    .done-btn { width:100%; background:#fe2c55; color:#fff; border:none; border-radius:8px; padding:13px; font-size:16px; cursor:pointer; }
    .done-btn[disabled] { opacity:0.6; cursor:not-allowed; }

    .sheet-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transition: all .25s ease; z-index:1500; }
    .sheet-backdrop.active { opacity: 1; visibility: visible; }
    .sheet { position: fixed; left: 0; right: 0; bottom: -100%; background: #fff; border-top-left-radius:20px; border-top-right-radius:20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); transition: bottom .25s ease; z-index:1501; }
    .sheet.active { bottom: 0; }
    .sheet-header { padding:16px 20px; text-align:center; font-size:18px; font-weight:700; border-bottom:1px solid #eee; position:relative; }
    .sheet-header button { position:absolute; right:20px; top:12px; border:none; background:none; font-size:22px; cursor:pointer; }
    .sheet-body { padding:20px; display:flex; flex-direction:column; gap:15px; }
    .sheet-body h4 { margin:0; font-size:15px; color:#555; }
    .coin-input-row { display:flex; align-items:center; justify-content:center; gap:8px; }
    .coin-input-row img { width:20px; height:20px; }
    .coin-input-row input { border:1.5px solid #ccc; border-radius:10px; padding:10px; font-size:16px; width:120px; text-align:center; outline:none; }

    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px, 1px, 1px, 1px); white-space:nowrap; }

    @media (max-width: 340px) {
      .coin-value { font-size:16px; }
      .coin-price { font-size:12px; }
    }
  </style>
</head>
<body>
  <div class="phone">

    <header class="ios-header">
      <button class="back-btn" type="button" aria-label="Trở lại">&lt;</button>
      <div class="ios-title">Get Coins to send Gifts to TikTok</div>
      <div style="width:48px;" aria-hidden="true"></div>
    </header>

    <div class="main-content">
      <main class="container">
        <div class="balance-box" aria-hidden="false">
          <img src="tiktok.png" class="tiktok-logo" alt="TikTok logo">
          <div class="balance-info">
            <span class="recharge-text">Recharge</span>
            <div class="balance-line">
              <img src="coin.png" class="coin-icon" alt="coin icon">
              <input type="text" id="balanceAmount" value="2,506,051" readonly aria-readonly="true" />
            </div>
          </div>
        </div>

        <section class="recharge-section" aria-label="Get Coins section">
          <h3>Get Coins</h3>

          <label for="tiktokId" class="visually-hidden">TikTok username</label>
          <div class="tiktok-input-wrapper">
            <span class="at-symbol" aria-hidden="true">@</span>
            <input type="text" id="tiktokId" placeholder="username" aria-label="TikTok username" autocomplete="username">
          </div>

          <div class="coins-grid" role="list">
            <div class="coin-option" role="button" tabindex="0" data-coins="70" data-price="1.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">70</div>
              <div class="coin-price">$1.00</div>
            </div>
            <div class="coin-option" role="button" tabindex="0" data-coins="350" data-price="5.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">350</div>
              <div class="coin-price">$5.00</div>
            </div>
            <div class="coin-option" role="button" tabindex="0" data-coins="700" data-price="9.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">700</div>
              <div class="coin-price">$9.00</div>
            </div>
            <div class="coin-option" role="button" tabindex="0" data-coins="1700" data-price="19.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">1,700</div>
              <div class="coin-price">$19.00</div>
            </div>
            <div class="coin-option" role="button" tabindex="0" data-coins="3000" data-price="29.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">3,000</div>
              <div class="coin-price">$29.00</div>
            </div>
            <div class="coin-option" role="button" tabindex="0" data-coins="7000" data-price="69.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">7,000</div>
              <div class="coin-price">$69.00</div>
            </div>
            <div class="coin-option" role="button" tabindex="0" data-coins="17500" data-price="199.00">
              <div class="coin-value"><img src="coin.png" alt="coin icon">17,500</div>
              <div class="coin-price">$199.00</div>
            </div>
            <div class="coin-option" id="customOption" role="button" tabindex="0">
              <div class="coin-value"><img src="coin.png" alt="coin icon">Custom</div>
            </div>
          </div>
        </section>
      </main>

      <div class="payment-footer" aria-live="polite">
        <div class="payment-logos" aria-hidden="true">
          <img src="visa.png" class="pay-icon" alt="Visa">
          <img src="mastercard.png" class="pay-icon" alt="Mastercard">
          <img src="paypal.png" class="pay-icon" alt="PayPal">
          <img src="applepay.png" class="pay-icon" alt="Apple Pay">
          <img src="googlepay.png" class="pay-icon" alt="Google Pay">
          <img src="zalopay.png" class="pay-icon" alt="ZaloPay">
          <img src="momo.png" class="pay-icon" alt="MoMo">
          <img src="vnpay.png" class="pay-icon" alt="VNPay">
        </div>
        <div class="total-line"><span>Total:</span><span id="totalAmount">$0.00</span></div>
        <button class="done-btn" id="rechargeBtn" type="button" disabled>Recharge</button>
      </div>
    </div>

    <div class="sheet-backdrop" id="sheetBackdrop" aria-hidden="true"></div>
    <div class="sheet" id="customSheet" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="customTitle">
      <div class="sheet-header">
        <div id="customTitle">Custom</div>
        <button id="closeSheet" type="button" aria-label="Close">&times;</button>
      </div>
      <div class="sheet-body">
        <h4>Number of Coins</h4>
        <div class="coin-input-row">
          <img src="coin.png" alt="coin icon">
          <label for="customCoinInput" class="visually-hidden">Number of coins</label>
          <input type="number" id="customCoinInput" placeholder="Enter coins" aria-label="Number of coins" min="1" step="1" inputmode="numeric">
        </div>
        <button class="done-btn" id="confirmCustom" type="button">Recharge</button>
      </div>
    </div>

  </div>

  <script>
    const coinOptions = Array.from(document.querySelectorAll('.coin-option'));
    const customOption = document.getElementById('customOption');
    const totalAmountEl = document.getElementById('totalAmount');
    const sheet = document.getElementById('customSheet');
    const sheetBackdrop = document.getElementById('sheetBackdrop');
    const closeSheet = document.getElementById('closeSheet');
    const confirmCustom = document.getElementById('confirmCustom');
    const customInput = document.getElementById('customCoinInput');
    const rechargeBtn = document.getElementById('rechargeBtn');
    const tiktokIdInput = document.getElementById('tiktokId');
    const balanceInput = document.getElementById('balanceAmount');

    let selectedCoins = 0;
    let selectedPrice = 0;
    let coinOptionsDisabled = false;
    const STORAGE_KEY = 'recharge_balance';

    // default rate
    const firstPriced = coinOptions.find(o => o.dataset.coins && o.dataset.price);
    const DEFAULT_RATE = (firstPriced && parseInt(firstPriced.dataset.coins, 10) > 0)
      ? (parseFloat(firstPriced.dataset.price) / parseInt(firstPriced.dataset.coins, 10))
      : (1.0 / 70);

    // load balance from localStorage (persistent). If none, read from HTML default and persist it.
    function loadBalance() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored !== null) {
          const num = Number(stored);
          if (!Number.isNaN(num)) {
            balanceInput.value = num.toLocaleString();
            return;
          }
        }
        // fallback: parse existing value in DOM and persist
        const raw = (balanceInput.value || '').toString().replace(/,/g, '');
        const num = Number(raw) || 0;
        localStorage.setItem(STORAGE_KEY, String(num));
        balanceInput.value = num.toLocaleString();
      } catch (e) {
        // ignore localStorage errors
        try {
          const raw = (balanceInput.value || '').toString().replace(/,/g, '');
          const num = Number(raw) || 0;
          balanceInput.value = num.toLocaleString();
        } catch {}
      }
    }

    function saveBalance(num) {
      try {
        localStorage.setItem(STORAGE_KEY, String(Number(num) || 0));
      } catch (e) { /* ignore */ }
    }

    // add coins (lũy tiến) and persist
    function addCoinsToBalance(coinsToAdd) {
      try {
        const raw = (balanceInput.value || '').toString().replace(/,/g, '');
        const current = Number(raw) || 0;
        const next = current + Number(coinsToAdd || 0);
        balanceInput.value = next.toLocaleString();
        saveBalance(next);
      } catch (e) {
        // ignore
      }
    }

    function setCoinOptionsDisabled(disabled) {
      coinOptionsDisabled = !!disabled;
      coinOptions.forEach(o => {
        if (coinOptionsDisabled) {
          o.classList.add('disabled');
          o.setAttribute('aria-disabled', 'true');
        } else {
          o.classList.remove('disabled');
          o.removeAttribute('aria-disabled');
        }
      });
    }

    const openSheet = () => {
      if (coinOptionsDisabled) return;
      sheet.classList.add('active');
      sheetBackdrop.classList.add('active');
      sheet.setAttribute('aria-hidden', 'false');
      sheetBackdrop.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      customInput.value = '';
      setTimeout(() => customInput.focus(), 50);
    };

    const closePopup = () => {
      sheet.classList.remove('active');
      sheetBackdrop.classList.remove('active');
      sheet.setAttribute('aria-hidden', 'true');
      sheetBackdrop.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      const focused = document.querySelector('.coin-option.selected') || document.querySelector('.coin-option');
      if (focused) focused.focus();
    };

    function updateRechargeState() {
      const hasUser = tiktokIdInput.value.trim().length > 0;
      const hasSelection = selectedCoins > 0 && selectedPrice > 0;
      rechargeBtn.disabled = !(hasUser && hasSelection);
    }

    coinOptions.forEach(option => {
      function selectOption() {
        if (coinOptionsDisabled) return;
        coinOptions.forEach(o => o.classList.remove('selected'));
        if (option.id === 'customOption') {
          openSheet();
        } else {
          option.classList.add('selected');
          const coins = parseInt(option.dataset.coins, 10);
          const price = parseFloat(option.dataset.price);
          selectedCoins = Number.isFinite(coins) ? coins : 0;
          selectedPrice = Number.isFinite(price) ? price : 0;
          totalAmountEl.textContent = '$' + selectedPrice.toFixed(2);
          updateRechargeState();
        }
      }
      option.addEventListener('click', selectOption);
      option.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectOption();
        }
      });
    });

    confirmCustom.addEventListener('click', () => {
      const val = parseInt(customInput.value, 10);
      if (!Number.isInteger(val) || val <= 0) {
        alert('Vui lòng nhập số xu hợp lệ (số nguyên dương).');
        customInput.focus();
        return;
      }
      selectedCoins = val;
      selectedPrice = +(val * DEFAULT_RATE);
      totalAmountEl.textContent = '$' + selectedPrice.toFixed(2);
      coinOptions.forEach(o => o.classList.remove('selected'));
      customOption.classList.add('selected');
      closePopup();
      updateRechargeState();
    });

    closeSheet.addEventListener('click', closePopup);
    sheetBackdrop.addEventListener('click', closePopup);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sheet.classList.contains('active')) closePopup();
    });

    tiktokIdInput.addEventListener('input', () => {
      updateRechargeState();
      // nếu đang disabled và user nhập username -> bật lại lựa chọn
      if (coinOptionsDisabled && tiktokIdInput.value.trim().length > 0) {
        setCoinOptionsDisabled(false);
      }
    });

    rechargeBtn.addEventListener('click', () => {
      const username = tiktokIdInput.value.trim();
      if (!username) {
        alert('Vui lòng nhập tên người dùng TikTok.');
        tiktokIdInput.focus();
        return;
      }
      if (!(selectedCoins > 0 && selectedPrice > 0)) {
        alert('Vui lòng chọn số xu cần nạp.');
        return;
      }
      const summary = `Xác nhận nạp\n\nUsername: @${username}\nCoins: ${selectedCoins.toLocaleString()}\nTotal: $${selectedPrice.toFixed(2)}\n\nTiếp tục?`;
      if (confirm(summary)) {
        rechargeBtn.disabled = true;
        const prevText = rechargeBtn.textContent;
        rechargeBtn.textContent = 'Processing...';

        // Mô phỏng call API; thay bằng gọi API thực tế
        setTimeout(() => {
          // nạp thành công -> cộng lũy tiến vào ví (persist)
          addCoinsToBalance(selectedCoins);

          // Sau khi hoàn tất:
          // - chỉ reset ô username
          // - tắt (disable) các lựa chọn coin
          // - total trở về 0
          tiktokIdInput.value = '';
          selectedCoins = 0;
          selectedPrice = 0;
          totalAmountEl.textContent = '$0.00';
          coinOptions.forEach(o => o.classList.remove('selected'));
          setCoinOptionsDisabled(true);

          alert('Mô phỏng nạp hoàn tất. Thay thế bằng gọi API ở server để hoàn tất giao dịch.');

          rechargeBtn.textContent = prevText;
          updateRechargeState();
        }, 1000);
      }
    });

    sheet.addEventListener('transitionend', () => {
      if (!sheet.classList.contains('active')) {
        const focused = document.querySelector('.coin-option.selected') || document.querySelector('.coin-option');
        if (focused) focused.focus();
      }
    });

    // init
    loadBalance();
    // note: options are enabled initially; if you want them disabled until username entered, call setCoinOptionsDisabled(true) here.
  </script>
</body>
</html>